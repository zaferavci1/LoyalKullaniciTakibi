@page
@model LoyalKullaniciTakip.Pages.EkMesai.BireyselEklemeModel
@{
    ViewData["Title"] = "Bireysel Ek Mesai Ekle";
}

<h1>Bireysel Ek Mesai Ekle</h1>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Başarılı!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Hata!</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>Bilgi:</strong> Bu sayfadan tek bir personel için ek mesai kaydı oluşturabilirsiniz.
    Tutar otomatik olarak hesaplanacaktır.
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Ek Mesai Bilgileri</h5>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="row g-3">
                <!-- Personel Seçimi -->
                <div class="col-md-6">
                    <label asp-for="SecilenPersonelID" class="form-label">Personel <span class="text-danger">*</span></label>
                    <select asp-for="SecilenPersonelID" class="form-select" asp-items="Model.PersonelListesi"
                            id="personelSelect" required></select>
                </div>

                <!-- Tarih Seçimi -->
                <div class="col-md-6">
                    <label asp-for="SecilenTarih" class="form-label">Tarih <span class="text-danger">*</span></label>
                    <input asp-for="SecilenTarih" type="date" class="form-control" id="tarihInput" required />
                </div>

                <!-- Ek Mesai Saati -->
                <div class="col-md-6">
                    <label asp-for="EkMesaiSaati" class="form-label">Ek Mesai Saati <span class="text-danger">*</span></label>
                    <input asp-for="EkMesaiSaati" type="number" class="form-control" id="saatInput"
                           step="0.5" min="0.5" max="24" placeholder="Örnek: 2.5" required />
                    <small class="form-text text-muted">0.5 ile 24 saat arasında bir değer girin</small>
                </div>

                <!-- Açıklama -->
                <div class="col-md-6">
                    <label asp-for="Aciklama" class="form-label">Açıklama</label>
                    <textarea asp-for="Aciklama" class="form-control" rows="3"
                              placeholder="Örnek: Proje son teslim tarihi nedeniyle yapılan ek mesai"></textarea>
                </div>

                <!-- Katsayı Bilgileri ve Manuel Giriş -->
                <div class="col-md-12">
                    <div class="card border-info mt-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-calculator"></i> Ek Mesai Katsayısı
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <strong>Sistem Ayarları (Genel Ayarlar'dan):</strong>
                                    <div class="d-flex gap-3 mt-2">
                                        <span class="badge bg-primary fs-6">Hafta İçi: @Model.HaftaIciKatsayi.ToString("F2")x</span>
                                        <span class="badge bg-warning text-dark fs-6">Cumartesi: @Model.CumartesiKatsayi.ToString("F2")x</span>
                                        <span class="badge bg-danger fs-6">Pazar: @Model.PazarKatsayi.ToString("F2")x</span>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        Sistem, seçilen tarihin gün tipine göre yukarıdaki katsayıyı otomatik kullanacaktır.
                                    </small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label asp-for="ManuelKatsayi" class="form-label">
                                        Manuel Katsayı (İsteğe Bağlı)
                                    </label>
                                    <input asp-for="ManuelKatsayi" type="number" class="form-control"
                                           step="0.1" min="0" placeholder="Örnek: 3.0" />
                                    <small class="form-text text-muted">
                                        Özel durumlar için manuel katsayı girebilirsiniz (örn: 3x mesai).
                                        Boş bırakırsanız sistem otomatik katsayıyı kullanır.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Önizleme Kartı -->
            <div class="mt-4" id="previewCard" style="display: none;">
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-calculator"></i> Tutar Önizleme
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <strong>Gün Tipi:</strong>
                                <div id="previewGunTipi" class="text-primary fs-5">-</div>
                            </div>
                            <div class="col-md-3">
                                <strong>Katsayı:</strong>
                                <div id="previewKatsayi" class="text-info fs-5">-</div>
                            </div>
                            <div class="col-md-3">
                                <strong>Saatlik Ücret:</strong>
                                <div id="previewSaatlikUcret" class="text-secondary fs-5">-</div>
                            </div>
                            <div class="col-md-3">
                                <strong>Toplam Tutar:</strong>
                                <div id="previewTutar" class="text-success fs-4 fw-bold">-</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Hesaplama: Saatlik Ücret × Ek Mesai Saati × Katsayı
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bilgilendirme -->
            <div class="alert alert-warning mt-4">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Dikkat:</strong>
                <ul class="mb-0 mt-2">
                    <li>Manuel katsayı girilmediğinde, tarihin gün tipine göre otomatik katsayı uygulanacaktır</li>
                    <li>Saatlik ücret, personelin aylık maaşından otomatik hesaplanacaktır (Maaş / 225)</li>
                    <li>Aynı personel ve tarih için daha önce kayıt varsa hata alacaksınız</li>
                </ul>
            </div>

            <!-- Butonlar -->
            <div class="d-flex justify-content-between mt-4">
                <a asp-page="/EkMesai/Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Geri Dön
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Kaydet
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let previewTimeout = null;

    function updatePreview() {
        const personelId = document.getElementById('personelSelect').value;
        const tarih = document.getElementById('tarihInput').value;
        const saat = document.getElementById('saatInput').value;

        // Tüm alanlar doluysa önizleme yap
        if (personelId > 0 && tarih && saat > 0) {
            // Debounce: 500ms bekle
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                fetch(`/EkMesai/BireyselEkleme?handler=Preview&personelId=${personelId}&tarih=${tarih}&saat=${saat}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('previewCard').style.display = 'block';
                            document.getElementById('previewGunTipi').textContent = data.gunTipi;
                            document.getElementById('previewKatsayi').textContent = data.katsayi + 'x';
                            document.getElementById('previewSaatlikUcret').textContent = data.saatlikUcret + ' ₺';
                            document.getElementById('previewTutar').textContent = data.tutar + ' ₺';
                        } else {
                            document.getElementById('previewCard').style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Önizleme hatası:', error);
                        document.getElementById('previewCard').style.display = 'none';
                    });
            }, 500);
        } else {
            document.getElementById('previewCard').style.display = 'none';
        }
    }

    // Event listener'ları ekle
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('personelSelect').addEventListener('change', updatePreview);
        document.getElementById('tarihInput').addEventListener('change', updatePreview);
        document.getElementById('saatInput').addEventListener('input', updatePreview);

        // Sayfa yüklendiğinde varsa mevcut değerlere göre önizleme yap
        updatePreview();
    });
</script>
