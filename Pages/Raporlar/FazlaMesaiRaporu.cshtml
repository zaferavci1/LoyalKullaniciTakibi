@page
@model LoyalKullaniciTakip.Pages.Raporlar.FazlaMesaiRaporuModel
@{
    ViewData["Title"] = "Fazla Mesai Raporu";
}

<h1>Fazla Mesai Raporu</h1>
<hr />

<!-- Filtre Formu -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Rapor Filtreleri</h5>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="row g-3">
                <div class="col-md-2">
                    <label asp-for="SecilenAy" class="form-label">Ay</label>
                    <select asp-for="SecilenAy" class="form-select" asp-items="Model.AyListesi"></select>
                </div>
                <div class="col-md-2">
                    <label asp-for="SecilenYil" class="form-label">Yıl</label>
                    <select asp-for="SecilenYil" class="form-select" asp-items="Model.YilListesi"></select>
                </div>
                <div class="col-md-2">
                    <label asp-for="SecilenDepartmanID" class="form-label">Departman</label>
                    <select asp-for="SecilenDepartmanID" class="form-select" asp-items="Model.DepartmanListesi"></select>
                </div>
                <div class="col-md-2">
                    <label asp-for="SecilenMeslekID" class="form-label">Meslek</label>
                    <select asp-for="SecilenMeslekID" class="form-select" asp-items="Model.MeslekListesi"></select>
                </div>
                <div class="col-md-2">
                    <label asp-for="SecilenPersonelID" class="form-label">Personel</label>
                    <select asp-for="SecilenPersonelID" class="form-select" asp-items="Model.PersonelListesi"></select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Rapor Oluştur
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.RaporGosterilsin)
{
    @if (Model.Rapor.Any())
    {
        <!-- Özet İstatistikler -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-white-50">Toplam FM Yapan Personel</h6>
                        <h2 class="mb-0">@Model.Rapor.Count</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-white-50">Toplam FM Saati</h6>
                        <h2 class="mb-0">@Model.Rapor.Sum(r => r.ToplamFazlaMesaiSaati).ToString("F1")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2">Hafta İçi FM</h6>
                        <h2 class="mb-0">@Model.Rapor.Sum(r => r.HaftaIciFazlaMesai).ToString("F1")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h6 class="card-subtitle mb-2 text-white-50">Hafta Sonu/Tatil FM</h6>
                        <h2 class="mb-0">@Model.Rapor.Sum(r => r.CumartesiFazlaMesai + r.PazarTatilFazlaMesai).ToString("F1")</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rapor Tablosu -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Fazla Mesai Detayları</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Personel</th>
                                <th class="text-end">Toplam FM Saati</th>
                                <th class="text-end">Hafta İçi FM</th>
                                <th class="text-end">Cumartesi FM</th>
                                <th class="text-end">Pazar/Tatil FM</th>
                                <th class="text-center">FM Gün Sayısı</th>
                                <th class="text-center">Detay</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var satir in Model.Rapor)
                            {
                                <tr>
                                    <td><strong>@satir.PersonelAdSoyad</strong></td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">@satir.ToplamFazlaMesaiSaati.ToString("F1") saat</span>
                                    </td>
                                    <td class="text-end">@satir.HaftaIciFazlaMesai.ToString("F1")</td>
                                    <td class="text-end">@satir.CumartesiFazlaMesai.ToString("F1")</td>
                                    <td class="text-end">@satir.PazarTatilFazlaMesai.ToString("F1")</td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">@satir.FazlaMesaiGunSayisi gün</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-info" type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#detay_@satir.PersonelAdSoyad.Replace(" ", "_")"
                                                aria-expanded="false">
                                            <i class="bi bi-chevron-down"></i> Göster
                                        </button>
                                    </td>
                                </tr>
                                <tr class="collapse" id="detay_@satir.PersonelAdSoyad.Replace(" ", "_")">
                                    <td colspan="7" class="p-0">
                                        <div class="bg-light p-3">
                                            <h6 class="text-primary mb-3">@satir.PersonelAdSoyad - Günlük Fazla Mesai Detayları</h6>
                                            <table class="table table-sm table-bordered mb-0">
                                                <thead class="table-secondary">
                                                    <tr>
                                                        <th>Tarih</th>
                                                        <th>Gün</th>
                                                        <th>Durum</th>
                                                        <th class="text-end">Toplam Mesai</th>
                                                        <th class="text-end">Normal Mesai</th>
                                                        <th class="text-end">Fazla Mesai</th>
                                                        <th>FM Tipi</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var detay in satir.Detaylar)
                                                    {
                                                        var rowClass = detay.FazlaMesaiTipi == "Pazar/Tatil" ? "table-danger" :
                                                                       detay.FazlaMesaiTipi == "Cumartesi" ? "table-warning" : "";
                                                        <tr class="@rowClass">
                                                            <td>@detay.Tarih.ToString("dd.MM.yyyy")</td>
                                                            <td>@detay.Gun</td>
                                                            <td>@detay.PuantajDurum</td>
                                                            <td class="text-end">@detay.ToplamMesaiSaati.ToString("F1")</td>
                                                            <td class="text-end">@detay.NormalMesai.ToString("F1")</td>
                                                            <td class="text-end">
                                                                <strong class="text-primary">@detay.FazlaMesai.ToString("F1")</strong>
                                                            </td>
                                                            <td>
                                                                @if (detay.FazlaMesaiTipi == "Pazar/Tatil")
                                                                {
                                                                    <span class="badge bg-danger">@detay.FazlaMesaiTipi</span>
                                                                }
                                                                else if (detay.FazlaMesaiTipi == "Cumartesi")
                                                                {
                                                                    <span class="badge bg-warning text-dark">@detay.FazlaMesaiTipi</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-info">@detay.FazlaMesaiTipi</span>
                                                                }
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Fazla mesai bulunamadı.</strong> Seçilen kriterlere göre fazla mesai yapan personel bulunmamaktadır.
        </div>
    }
}
else
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        Rapor görmek için yukarıdaki filtrelerden ay/yıl seçip <strong>"Rapor Oluştur"</strong> butonuna tıklayın.
    </div>
}

<div class="mt-3">
    <a asp-page="/Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Ana Sayfaya Dön
    </a>
</div>

<style>
    .table-responsive {
        max-height: none;
    }

    .collapse.show {
        animation: slideDown 0.3s ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
